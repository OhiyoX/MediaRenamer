# 媒体文件智能重命名工具

## 🎯 项目简介

这是一个功能强大的媒体文件智能重命名工具，专门为动漫、电影、纪录片等媒体文件设计。支持基于正则表达式的智能重命名，具有图形化界面、热重载、自动规则匹配等高级功能。

### ✨ 核心特性

- 🎬 **多格式支持**：支持视频文件（mkv、mp4、avi等）和字幕文件（srt、ass、ssa等）
- 🧠 **智能匹配**：自动分析文件名并选择最合适的重命名规则
- 🎨 **图形界面**：直观的GUI界面，支持实时预览和测试
- 🔄 **热重载**：支持代码热重载，开发调试更便捷
- 📝 **规则管理**：丰富的预置规则，支持自定义规则创建
- 💾 **安全备份**：自动备份原文件，支持一键恢复
- 📊 **详细日志**：完整的重命名记录和操作日志

### 🏗️ 架构优势

**重构成果**：
- ✅ 原始文件：1459行 → 重构后：415行 (减少71%)
- ✅ 模块化：拆分为11个独立模块
- ✅ 代码质量：大幅提升可维护性和可读性

**重构架构**：
- **UI组件层** (`components/`)：7个独立UI组件
- **业务逻辑层** (`logic/`)：2个业务逻辑模块  
- **主控制器**：协调各组件的主控制器

## 📁 项目结构

项目采用高度模块化的设计，所有代码都放在 `libs` 目录下，结构清晰且易于维护：

```
刮削重命名/
├── 📄 main.py                   # 主程序入口
├── 📄 start.py                  # 启动脚本
├── 📄 README.md                 # 项目说明文档
├── 📁 libs/                     # 核心代码目录
│   ├── ⚙️ config.py            # 配置文件和常量定义
│   ├── 📁 core/                # 核心业务逻辑模块
│   │   ├── 📄 rule.py          # 规则管理（RegexRule, RuleFileManager）
│   │   ├── 📄 file_manager.py  # 文件操作（扫描、备份、重命名）
│   │   ├── 📄 renamer.py       # 重命名逻辑（MediaRenamer）
│   │   └── 📄 auto_matcher.py  # 自动规则匹配（RuleMatcher）
│   ├── 🖥️ gui/                 # 图形界面模块
│   │   ├── 📄 main_window.py   # 主窗口
│   │   └── 📁 tabs/            # 各个标签页
│   │       ├── 📄 file_processing.py  # 文件处理标签页（已重构）
│   │       ├── 📁 components/        # UI组件模块
│   │       │   ├── 📄 directory_selector.py    # 目录选择组件
│   │       │   ├── 📄 rule_selector.py       # 规则选择组件
│   │       │   ├── 📄 rule_detail_display.py # 规则详情显示组件
│   │       │   ├── 📄 title_editor.py        # 剧集名编辑组件
│   │       │   ├── 📄 preview_display.py     # 预览显示组件
│   │       │   ├── 📄 action_buttons.py      # 操作按钮组件
│   │       │   └── 📄 status_bar.py          # 状态栏组件
│   │       ├── 📁 logic/              # 业务逻辑模块
│   │       │   ├── 📄 file_processing_logic.py # 核心业务逻辑
│   │       │   └── 📄 result_handler.py       # 结果处理逻辑
│   │       ├── 📄 rule_testing.py    # 规则测试标签页
│   │       ├── 📄 rule_management.py  # 规则管理标签页
│   │       └── 📄 hot_reload.py      # 热重载状态标签页
│   ├── 🔧 utils/               # 工具模块
│   │   └── 📄 hot_reload.py    # 热重载功能
│   └── 📄 media_renamer.py     # 原始单文件版本（保留）
├── 📁 rules/                   # 规则文件目录（30+个预置规则）
│   ├── 📄 日式剧集格式.json
│   ├── 📄 标准剧集格式.json
│   ├── 📄 电影格式.json
│   ├── 📄 CASO完整格式.json
│   ├── 📄 YYDM-11FANS格式.json
│   └── 📄 ... (更多规则)
└── 📁 venv/                   # 虚拟环境（如果使用）
```

## 🔧 模块说明

### 🎯 核心模块 (libs/core/)

**rule.py** - 规则管理核心
- `RegexRule`: 正则表达式规则类，负责规则匹配和文件名生成
- `RuleFileManager`: 规则文件管理器，负责规则的加载、保存和删除

**file_manager.py** - 文件操作核心
- `FileManager`: 文件扫描、备份、重命名等文件操作功能
- 支持批量文件处理和安全备份机制

**renamer.py** - 重命名逻辑核心
- `MediaRenamer`: 媒体文件重命名的核心逻辑
- 包含预览和执行重命名功能
- 支持文件名清理和格式化

**auto_matcher.py** - 智能匹配核心
- `RuleMatcher`: 自动规则匹配功能
- 智能分析文件名并选择最合适的规则
- 支持规则优先级和权重计算

### 🖥️ 图形界面模块 (libs/gui/)

**main_window.py** - 主窗口控制器
- `MainWindow`: 负责应用程序的主界面和各个标签页的协调
- 集成热重载功能和规则管理

**tabs/** - 功能标签页集合
- `file_processing.py`: 文件处理标签页（已重构），负责文件选择、规则选择、预览和执行重命名
- `rule_testing.py`: 规则测试标签页，负责正则表达式测试和规则创建
- `rule_management.py`: 规则管理标签页，负责规则的查看、删除等管理操作
- `hot_reload.py`: 热重载状态标签页，负责热重载功能的控制和状态显示

**components/** - UI组件库
- `directory_selector.py`: 目录选择组件
- `rule_selector.py`: 规则选择组件
- `rule_detail_display.py`: 规则详情显示组件
- `title_editor.py`: 剧集名编辑组件
- `preview_display.py`: 预览显示组件
- `action_buttons.py`: 操作按钮组件
- `status_bar.py`: 状态栏组件

**logic/** - 业务逻辑层
- `file_processing_logic.py`: 核心业务逻辑处理
- `result_handler.py`: 结果处理逻辑

### 🔧 工具模块 (libs/utils/)

**hot_reload.py** - 热重载功能
- `HotReloadManager`: 热重载管理器
- 负责代码热重载和文件监控
- 支持开发时的实时调试

### ⚙️ 配置文件

**libs/config.py** - 统一配置管理
- 支持的视频文件扩展名（mkv、mp4、avi等）
- 支持的字幕文件扩展名（srt、ass、ssa等）
- 默认规则配置
- GUI配置参数
- 热重载配置

## 重构优势

### 🏗️ 架构优势
1. **模块化设计**: 每个模块职责单一，便于维护和扩展
2. **代码复用**: 核心逻辑与GUI分离，便于测试和复用
3. **易于扩展**: 新增功能只需添加对应的模块
4. **清晰的依赖关系**: 模块间的依赖关系更加明确
5. **更好的测试性**: 每个模块可以独立测试
6. **统一管理**: 所有代码都在libs目录下，便于管理

### 📊 FileProcessingTab 重构优势
1. **单一职责原则**: 每个组件只负责一个特定的UI功能
2. **可维护性提升**: 代码行数大幅减少，易于阅读和理解
3. **可测试性**: 每个组件可以独立测试
4. **可扩展性**: 新增功能只需添加新的组件
5. **代码复用**: 组件可以在其他标签页中复用
6. **松耦合设计**: 组件间通过事件驱动通信，便于替换和升级

## 🚀 快速开始

### 📦 安装要求

- **Python**: 3.7+ 
- **依赖包**: 
  - `tkinter` (通常随Python安装)
  - `watchdog` (可选，用于热重载功能)

### 🎮 运行方式

**方法一：直接运行**
```bash
python main.py
```

**方法二：使用启动脚本**
```bash
python start.py
```

### 🎯 基本使用流程

1. **选择目录**：点击"选择目录"按钮，选择包含媒体文件的文件夹
2. **智能匹配**：点击"批量匹配建议规则"，系统自动分析文件名并推荐规则
3. **预览结果**：查看预览区域，确认重命名效果
4. **执行重命名**：点击"执行建议重命名"完成批量重命名
5. **恢复功能**：如需恢复，点击"恢复文件名"按钮

## 📋 功能详解

### 🧠 智能规则匹配

系统内置30+个专业规则，支持多种命名格式：

**规则优先级**：
- 🥇 **专用格式** (权重25)：乱马1/2、Evangelion等专用规则
- 🥈 **字幕组格式** (权重12-16)：CASO、YYDM-11FANS、HYSUB等
- 🥉 **通用格式** (权重1-10)：日式剧集、标准剧集、电影等

**示例匹配**：
```
原文件: 人魚の森.2003.第01話.1280x720.DVDRIP.x264.AC3.avi
匹配规则: 日式剧集格式
新文件: 人魚の森 (2003) S01E01 - 第01話.1280x720.DVDRIP.x264.AC3.avi
```

### 🎬 多格式支持

**视频文件**：`.mkv`, `.mp4`, `.avi`, `.mov`, `.wmv`, `.flv`, `.webm`, `.m4v`, `.mpg`, `.mpeg`, `.3gp`, `.ogv`, `.ts`, `.m2ts`

**字幕文件**：`.srt`, `.ass`, `.ssa`, `.sub`, `.idx`, `.vtt`, `.ttml`, `.dfxp`, `.smi`, `.sami`

### 🏷️ 自定义标题功能

支持自定义重命名时的标题部分：

**使用方法**：
1. 在"Title编辑"区域输入自定义标题（如："人鱼之森"）
2. 点击"应用Title到所有文件"按钮
3. 查看预览效果，确认无误后执行重命名

**示例**：
```
原文件: 人魚の森.2003.第01話.1280x720.DVDRIP.x264.AC3.avi
自定义title: 人鱼之森
新文件: 人鱼之森 (2003) S01E01 - 第01話.1280x720.DVDRIP.x264.AC3.avi
```

### 💾 安全备份与恢复

**自动备份**：每次重命名前自动备份原文件到 `backup` 目录

**重命名记录**：所有操作记录到 `rename_log.json` 文件
```json
[
  {
    "timestamp": "2025-10-03T19:10:36.539791",
    "old_name": "人魚の森.2003.第01話.1280x720.DVDRIP.x264.AC3.avi",
    "new_name": "人魚の森 (2003) S01E01 - 第01話.1280x720.DVDRIP.x264.AC3.avi",
    "rule_name": "日式剧集格式",
    "directory": "V:\\Media\\Animes\\人鱼之森"
  }
]
```

**一键恢复**：点击"恢复文件名"按钮，根据记录文件恢复所有重命名

### 🔄 热重载功能

**开发调试利器**：
- 支持代码热重载，修改代码后自动重新加载
- 实时监控文件变化，无需重启程序
- 开发时大幅提升调试效率

**使用方法**：
1. 在"热重载"标签页中启用热重载功能
2. 修改代码文件后自动检测并重新加载
3. 查看重载日志和状态信息

### 🧪 规则测试与管理

**规则测试**：
- 内置规则测试工具，支持正则表达式测试
- 实时预览规则匹配效果
- 支持自定义规则创建和保存

**规则管理**：
- 查看所有预置规则
- 支持规则删除和导入
- 规则优先级管理

### 📊 详细统计信息

**匹配统计**：
- 显示总文件数、成功匹配数、匹配率
- 按规则类型统计匹配结果
- 实时更新匹配进度

**操作日志**：
- 完整的操作记录和错误日志
- 支持日志导出和查看
- 便于问题排查和调试

## 🛠️ 开发指南

### 🏗️ 架构设计

**模块化架构**：
- **核心层** (`libs/core/`)：业务逻辑和数据处理
- **界面层** (`libs/gui/`)：用户界面和交互
- **工具层** (`libs/utils/`)：辅助功能和工具
- **配置层** (`libs/config.py`)：统一配置管理

**组件化设计**：
- 每个UI功能独立成组件
- 组件间通过回调函数通信
- 业务逻辑与UI完全分离

### 🔧 添加新功能

**添加新规则**：
1. 在 `rules/` 目录下创建新的 `.json` 规则文件
2. 在 `libs/core/auto_matcher.py` 中添加规则权重
3. 测试规则匹配效果

**添加新UI组件**：
```python
# 1. 在 components/ 目录下创建新组件
class NewComponent:
    def __init__(self, parent_frame, on_event_callback):
        self.parent_frame = parent_frame
        self.on_event_callback = on_event_callback
        self.create_widgets()
    
    def create_widgets(self):
        # 创建UI组件
        pass

# 2. 在主控制器中使用组件
class FileProcessingTab:
    def __init__(self, ...):
        self.new_component = NewComponent(
            self.frame, 
            self.on_new_event
        )
    
    def on_new_event(self, data):
        # 处理事件
        pass
```

**添加新标签页**：
1. 在 `libs/gui/tabs/` 目录下创建新标签页
2. 在 `libs/gui/main_window.py` 中集成新标签页
3. 添加对应的业务逻辑处理

### 🧪 开发调试

**热重载调试**：
- 启用热重载功能后，修改代码自动重新加载
- 查看重载日志了解加载状态
- 支持断点调试和错误追踪

**规则测试**：
- 使用内置规则测试工具验证正则表达式
- 实时预览规则匹配效果
- 支持批量测试和性能分析

### 📈 性能优化

**文件处理优化**：
- 支持大文件批量处理
- 异步文件操作，避免界面卡顿
- 智能缓存机制，提升重复操作效率

**内存管理**：
- 及时释放大文件对象
- 优化正则表达式编译
- 合理使用缓存策略

## 📊 项目统计

### 🎯 重构成果

| 指标 | 原始版本 | 重构版本 | 提升 |
|------|----------|----------|------|
| **文件数量** | 1个文件 | 11个模块 | 模块化 |
| **代码行数** | 1459行 | ~1000行 | 减少31% |
| **可维护性** | ⭐⭐ | ⭐⭐⭐⭐⭐ | 大幅提升 |
| **可测试性** | ⭐ | ⭐⭐⭐⭐⭐ | 完全重构 |
| **可扩展性** | ⭐⭐ | ⭐⭐⭐⭐⭐ | 组件化 |

### 🏆 技术亮点

- **模块化架构**：11个独立模块，职责清晰
- **组件化UI**：7个UI组件，高度复用
- **智能匹配**：30+专业规则，自动选择
- **热重载**：开发调试利器
- **安全备份**：自动备份+一键恢复
- **多格式支持**：视频+字幕文件全覆盖

### 📈 版本历程

1. **v1.0** - 单文件版本 (`media_renamer.py`)
2. **v2.0** - 基础模块化重构
3. **v3.0** - UI组件化重构 (当前版本)

---

## 📄 许可证

本项目采用开源许可证，欢迎贡献代码和建议。

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request 来改进这个项目！

- 🐛 **Bug报告**：请详细描述问题和复现步骤
- ✨ **功能建议**：欢迎提出新功能想法
- 📝 **文档改进**：帮助完善文档和示例
- 🔧 **代码贡献**：遵循现有代码风格和架构