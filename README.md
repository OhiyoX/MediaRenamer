# 媒体文件智能重命名工具 - 重构版本

## 项目结构

重构后的项目采用模块化设计，所有代码都放在 `libs` 目录下，文件结构更加清晰和易于维护：

```
刮削重命名/
├── main.py                   # 主程序入口
├── start.py                  # 启动脚本
├── README.md                 # 项目说明文档
├── libs/                     # 核心代码目录
│   ├── config.py            # 配置文件和常量定义
│   ├── core/                # 核心业务逻辑模块
│   │   ├── __init__.py
│   │   ├── rule.py          # 规则管理（RegexRule, RuleFileManager）
│   │   ├── file_manager.py  # 文件操作（扫描、备份、重命名）
│   │   ├── renamer.py       # 重命名逻辑（MediaRenamer）
│   │   └── auto_matcher.py  # 自动规则匹配（RuleMatcher）
│   ├── gui/                 # 图形界面模块
│   │   ├── __init__.py
│   │   ├── main_window.py   # 主窗口
│   │   └── tabs/            # 各个标签页
│   │       ├── __init__.py
│   │       ├── file_processing.py  # 文件处理标签页
│   │       ├── rule_testing.py    # 规则测试标签页
│   │       ├── rule_management.py  # 规则管理标签页
│   │       └── hot_reload.py      # 热重载状态标签页
│   ├── utils/               # 工具模块
│   │   ├── __init__.py
│   │   └── hot_reload.py    # 热重载功能
│   └── media_renamer.py     # 原始单文件版本（保留）
├── rules/                   # 规则文件目录
│   ├── 标准剧集格式.json
│   ├── 电影格式.json
│   ├── 纪录片格式.json
│   ├── 简单数字格式.json
│   └── 带季数剧集格式.json
└── venv/                   # 虚拟环境（如果使用）
```

## 模块说明

### 核心模块 (libs/core/)

- **rule.py**: 包含 `RegexRule` 类和 `RuleFileManager` 类
  - `RegexRule`: 正则表达式规则类，负责规则匹配和文件名生成
  - `RuleFileManager`: 规则文件管理器，负责规则的加载、保存和删除

- **file_manager.py**: 包含 `FileManager` 类
  - 文件扫描、备份、重命名等文件操作功能

- **renamer.py**: 包含 `MediaRenamer` 类
  - 媒体文件重命名的核心逻辑，包括预览和执行重命名

- **auto_matcher.py**: 包含 `RuleMatcher` 类
  - 自动规则匹配功能，智能分析文件名并选择最合适的规则

### 图形界面模块 (libs/gui/)

- **main_window.py**: 主窗口类 `MainWindow`
  - 负责应用程序的主界面和各个标签页的协调

- **tabs/**: 各个功能标签页
  - `file_processing.py`: 文件处理标签页，负责文件选择、规则选择、预览和执行重命名
  - `rule_testing.py`: 规则测试标签页，负责正则表达式测试和规则创建
  - `rule_management.py`: 规则管理标签页，负责规则的查看、删除等管理操作
  - `hot_reload.py`: 热重载状态标签页，负责热重载功能的控制和状态显示

### 工具模块 (libs/utils/)

- **hot_reload.py**: 热重载功能
  - `HotReloadManager`: 热重载管理器，负责代码热重载和文件监控

### 配置文件

- **libs/config.py**: 包含所有常量定义和配置项
  - 支持的视频文件扩展名
  - 默认规则配置
  - GUI配置参数
  - 热重载配置

## 重构优势

1. **模块化设计**: 每个模块职责单一，便于维护和扩展
2. **代码复用**: 核心逻辑与GUI分离，便于测试和复用
3. **易于扩展**: 新增功能只需添加对应的模块
4. **清晰的依赖关系**: 模块间的依赖关系更加明确
5. **更好的测试性**: 每个模块可以独立测试
6. **统一管理**: 所有代码都在libs目录下，便于管理

## 使用方法

### 方法一：直接运行
```bash
python main.py
```

### 方法二：使用启动脚本
```bash
python start.py
```

## 依赖要求

- Python 3.7+
- tkinter (通常随Python安装)
- watchdog (可选，用于热重载功能)

## 功能特性

- ✅ 图形化界面操作
- ✅ 基于正则表达式的文件重命名
- ✅ 规则文件管理
- ✅ 实时预览和测试
- ✅ 热重载支持
- ✅ 文件备份功能
- ✅ 多标签页界面
- ✅ 模块化架构
- ✅ **自动规则匹配功能** - 智能分析文件名并自动选择最合适的规则

### 🎯 批量匹配和执行建议规则

现在分为两个步骤，更加安全和可控：

**第一步：批量匹配建议规则**
- 点击"批量匹配建议规则"按钮
- 系统会为每个文件分析并推荐最合适的规则
- 显示匹配统计信息（总文件数、成功匹配数、匹配率）
- 在预览区域显示建议的规则和匹配分数
- **不会执行重命名操作**

**第二步：执行建议重命名**
- 查看预览区域，确认建议的规则无误
- 点击"执行建议重命名"按钮
- 显示建议规则统计信息
- 确认后执行实际的重命名操作
- 自动记录重命名操作到日志文件

**使用流程**:
1. 选择包含媒体文件的目录
2. 点击"批量匹配建议规则"分析文件
3. 查看匹配结果和建议规则
4. 确认无误后点击"执行建议重命名"
5. 查看执行结果

### 🏷️ Title重命名功能

现在支持自定义重命名时的标题部分：

**功能特点**:
- 在"Title编辑"区域可以输入自定义标题
- 支持应用到所有文件或清除自定义标题
- 自定义标题会替换原文件名中的title字段
- 支持实时预览自定义标题的效果

**使用方法**:
1. 在"Title编辑"区域输入自定义标题（如："人鱼之森"）
2. 点击"应用Title到所有文件"按钮
3. 查看预览区域，确认重命名效果
4. 执行重命名操作

**示例**:
- 原文件: `人魚の森.2003.第01話.1280x720.DVDRIP.x264.AC3.avi`
- 自定义title: `人鱼之森`
- 新文件: `人鱼之森 (2003) S01E01 - 第01話.1280x720.DVDRIP.x264.AC3.avi`

**注意事项**:
- 自定义标题会应用到所有匹配的文件
- 如果留空，则使用原文件名中的标题
- 支持中英文标题自定义
- **重要**：即使规则没有匹配到title字段，也可以设置自定义标题

**重命名记录**:
- 每次重命名操作都会自动记录到 `rename_log.json` 文件
- 记录包含：时间戳、原文件名、新文件名、使用的规则、目录路径
- 支持手动重命名和批量应用建议规则两种模式

**恢复功能**:
- 点击"恢复文件名"按钮可以一键恢复所有重命名
- 系统会读取重命名记录文件，将文件从新名称恢复为原始名称
- 支持确认对话框，显示记录数量和恢复说明
- 恢复完成后显示成功恢复的文件数量

**记录文件格式**:
```json
[
  {
    "timestamp": "2025-10-03T19:10:36.539791",
    "old_name": "人魚の森.2003.第01話.1280x720.DVDRIP.x264.AC3.avi",
    "new_name": "人魚の森 (2003) S01E01 - 第01話.1280x720.DVDRIP.x264.AC3.avi",
    "rule_name": "日式剧集格式",
    "directory": "V:\\Media\\Animes\\人鱼之森"
  }
]
```

**使用流程**:
1. 重命名文件（自动记录）
2. 如需恢复：点击"恢复文件名"按钮
3. 确认恢复操作
4. 查看恢复结果

### 📝 字幕文件支持

现在支持识别和处理字幕文件：

**支持的字幕格式**:
- `.srt` - SubRip字幕
- `.ass` - Advanced SubStation Alpha
- `.ssa` - SubStation Alpha
- `.sub` - MicroDVD字幕
- `.idx` - VobSub字幕
- `.vtt` - WebVTT字幕
- `.ttml` - Timed Text Markup Language
- `.dfxp` - Distribution Format Exchange Profile
- `.smi` - Synchronized Accessible Media Interchange
- `.sami` - Synchronized Accessible Media Interchange

**字幕文件处理**:
- 字幕文件会与对应的视频文件使用相同的重命名规则
- 保持字幕文件与视频文件的命名一致性
- 支持所有现有的重命名规则

#### 规则优先级：

- 带季数剧集格式 (权重: 10) - 最精确的剧集格式
- **日式剧集格式 (权重: 9)** - 日式动画剧集格式
- **日式OPED格式 (权重: 8)** - 日式OP/ED格式
- **日式OVA格式 (权重: 8)** - 日式OVA格式
- 标准剧集格式 (权重: 8)
- **日式菜单格式 (权重: 7)** - 日式菜单格式
- 电影格式 (权重: 7)
- 纪录片格式 (权重: 6)
- 简单数字格式 (权重: 3) - 最通用的格式

#### 新增日式规则支持：

针对日式动画命名格式，新增了4个专门规则：

1. **日式剧集格式**: `人魚の森.2003.第01話.1280x720.DVDRIP.x264.AC3.avi`
   - 输出: `人魚の森 (2003) S01E01 - 第01話.1280x720.DVDRIP.x264.AC3.avi`

2. **日式OPED格式**: `人魚の森.2003.OP.1280x720.DVDRIP.x264.AC3.mkv`
   - 输出: `人魚の森 (2003) - OP.1280x720.DVDRIP.x264.AC3.mkv`

3. **日式OVA格式**: `人魚の森.OVA.1991.1280x960.DVDRIP.x264.AC3.avi`
   - 输出: `人魚の森 OVA (1991).1280x960.DVDRIP.x264.AC3.avi`

4. **日式菜单格式**: `人魚の森.OVA.1991.MENU.1280x960.DVDRIP.x264.AC3.avi`
   - 输出: `人魚の森 OVA (1991) - MENU.1280x960.DVDRIP.x264.AC3.avi`

## 开发说明

如果需要添加新功能：

1. 在 `libs/core/` 目录下添加核心业务逻辑
2. 在 `libs/gui/tabs/` 目录下添加对应的GUI界面
3. 在 `libs/config.py` 中添加相关配置
4. 在 `libs/gui/main_window.py` 中集成新功能

这种模块化的设计使得代码更加清晰、易于维护和扩展。

## 版本说明

- **原始版本**: `libs/media_renamer.py` - 单文件版本，包含所有功能
- **重构版本**: 模块化版本，所有功能分布在不同的模块中

两个版本可以并存，用户可以根据需要选择使用哪个版本。